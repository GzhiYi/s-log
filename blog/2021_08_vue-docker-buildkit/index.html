<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=1280" name=viewport> <meta content=#333333 name=theme-color> <meta content=Mrn4dXO3Z_939geeswIgr2wIpspT6n7X5cX1Tjp69Ko name=google-site-verification> <base href=/ > <link href=global.css rel=stylesheet> <link href=manifest.json rel=manifest crossorigin=use-credentials> <link href=favicon.png rel=icon type=image/png> <link href=atom-one-light.min.css rel=stylesheet> <link href=client/client-8a023c34.css rel=stylesheet><link href=client/[slug]-669d1caa.css rel=stylesheet> <title>用docker构建vue项目镜像，与buildkit体积对比-GzhiYi's blog</title><meta content=用docker构建vue项目镜像，与buildkit体积对比 name=description data-svelte=svelte-2vncnt><meta content=docker，vue，buildkit，体积，缓存 name=keywords data-svelte=svelte-2vncnt> <link href=/client/client.1097f7bb.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/client-8a023c34.css rel=preload as=style><link href=/client/[slug].71aad685.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/config.026ad977.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/inject_styles.5607aec6.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/[slug]-669d1caa.css rel=preload as=style></head> <body> <div id=sapper> <nav class=svelte-1dbd5up><ul class=svelte-1dbd5up> <li class=svelte-1dbd5up><a href=blog aria-current=page class=svelte-1dbd5up rel=prefetch>blog</a></ul></nav> <main class=svelte-1ca6gui> <div class="svelte-1h4sz93 base"><div class="svelte-1h4sz93 title">用docker构建vue项目镜像，与buildkit体积对比</div> <span class="svelte-1h4sz93 author">GzhiYi · 2021-08-03</span> <div class=label>docker</div></div> <div class="svelte-1h4sz93 content"><h2 id=使用dockerfile去打包一个vue项目镜像>使用Dockerfile去打包一个vue项目镜像</h2> <pre><code class=language-bash>vue <span class=hljs-meta>create</span> hello-world
cd hello-world <span class=hljs-variable>&&</span> touch Dockerfile
</code></pre> <p>Dockerfile内容</p> <pre><code class=language-bash><span class=hljs-keyword>FROM</span> node:lts-alpine
<span class=hljs-keyword>RUN</span><span class=bash> npm install -g http-server</span>
<span class=hljs-keyword>WORKDIR</span><span class=bash> /app</span>
<span class=hljs-keyword>COPY</span><span class=bash> package*.json ./</span>
<span class=hljs-keyword>RUN</span><span class=bash> npm install </span>
<span class=hljs-keyword>COPY</span><span class=bash> . .</span>
<span class=hljs-keyword>RUN</span><span class=bash> npm run build</span>
<span class=hljs-keyword>EXPOSE</span> <span class=hljs-number>8080</span>
<span class=hljs-keyword>CMD</span><span class=bash> [<span class=hljs-string>"http-server"</span>, <span class=hljs-string>"dist"</span>]</span>
</code></pre> <h3 id=镜像构建与容器运行>镜像构建与容器运行</h3> <pre><code class=language-bash>docker build -t vue:demo . <span class=hljs-comment># 构建镜像</span>
docker <span class=hljs-built_in>run</span> -<span class=hljs-keyword>it</span> -d -P vue:demo
docker container ls <span class=hljs-comment># 查看映射的端口</span>
</code></pre> <p>查看生成的镜像大小为：287MB。</p> <h3 id=使用buildkit优化镜像体积>使用buildkit优化镜像体积</h3> <p>新的Dockerfile</p> <pre><code class=language-bash><span class=hljs-comment># systax = docker/dockerfile:experimental</span>
<span class=hljs-keyword>FROM</span> node:lts-alpine
<span class=hljs-builtin-name>RUN</span> npm install -g http-server
WORKDIR /app
COPY package*.json ./
<span class=hljs-builtin-name>RUN</span> <span class=hljs-attribute>--mount</span>=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked\
    <span class=hljs-attribute>--mount</span>=type=cache,target=/root/.npm,id=npm_cache \
    npm install 
COPY . .
<span class=hljs-builtin-name>RUN</span> <span class=hljs-attribute>--mount</span>=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \
    # <span class=hljs-attribute>--mount</span>=type=cache,target=/app/dist,id=my_app_dist,sharing=locked \
    npm <span class=hljs-builtin-name>run</span> build
EXPOSE 8080
CMD [<span class=hljs-string>"http-server"</span>, <span class=hljs-string>"dist"</span>]
</code></pre> <h3 id=构建镜像>构建镜像</h3> <pre><code class=language-bash><span class=hljs-attribute>DOCKER_BUILDKIT</span>=1 docker build -t vue:buildx .
</code></pre> <p>对比查看，tag为buildx的镜像体积为：124MB。</p> <p>体积减少了一半，是用buildkit对node_modules进行缓存处理。</p> </div> <div class="svelte-1h4sz93 contact"><div>如果你对这页内容有疑问，欢迎联系我！</div> <a href="mailto:zhiyi.gong@outlook.com?subject=【重要】用docker构建vue项目镜像，与buildkit体积对比&body=gzhiyi.top/blog/2021_08_vue-docker-buildkit" target=_blank>邮箱 </a> <br> <a href=https://github.com/gzhiyi target=_blank>github </a> </div> </main></div> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,(function(a){return {post:{title:a,description:a,keywords:"docker，vue，buildkit，体积，缓存",labels:["docker"],date:"2021-08-03",path:"2021\u002F08\u002Fvue-docker-buildkit.md",slug:"2021_08_vue-docker-buildkit",html:"\u003Ch2 id=\"使用dockerfile去打包一个vue项目镜像\"\u003E使用Dockerfile去打包一个vue项目镜像\u003C\u002Fh2\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003Evue \u003Cspan class=\"hljs-meta\"\u003Ecreate\u003C\u002Fspan\u003E hello-world\ncd hello-world \u003Cspan class=\"hljs-variable\"\u003E&amp;&amp;\u003C\u002Fspan\u003E touch Dockerfile\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EDockerfile内容\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"hljs-keyword\"\u003EFROM\u003C\u002Fspan\u003E node:lts-alpine\n\u003Cspan class=\"hljs-keyword\"\u003ERUN\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E npm install -g http-server\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003EWORKDIR\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E \u002Fapp\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003ECOPY\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E package*.json .\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003ERUN\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E npm install \u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003ECOPY\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E . .\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003ERUN\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E npm run build\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003EEXPOSE\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E8080\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003ECMD\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E [\u003Cspan class=\"hljs-string\"\u003E&quot;http-server&quot;\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-string\"\u003E&quot;dist&quot;\u003C\u002Fspan\u003E]\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch3 id=\"镜像构建与容器运行\"\u003E镜像构建与容器运行\u003C\u002Fh3\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003Edocker build -t vue:demo . \u003Cspan class=\"hljs-comment\"\u003E# 构建镜像\u003C\u002Fspan\u003E\ndocker \u003Cspan class=\"hljs-built_in\"\u003Erun\u003C\u002Fspan\u003E -\u003Cspan class=\"hljs-keyword\"\u003Eit\u003C\u002Fspan\u003E -d -P vue:demo\ndocker container ls \u003Cspan class=\"hljs-comment\"\u003E# 查看映射的端口\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E查看生成的镜像大小为：287MB。\u003C\u002Fp\u003E\n\u003Ch3 id=\"使用buildkit优化镜像体积\"\u003E使用buildkit优化镜像体积\u003C\u002Fh3\u003E\n\u003Cp\u003E新的Dockerfile\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"hljs-comment\"\u003E# systax = docker\u002Fdockerfile:experimental\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003EFROM\u003C\u002Fspan\u003E node:lts-alpine\n\u003Cspan class=\"hljs-builtin-name\"\u003ERUN\u003C\u002Fspan\u003E npm install -g http-server\nWORKDIR \u002Fapp\nCOPY package*.json .\u002F\n\u003Cspan class=\"hljs-builtin-name\"\u003ERUN\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-attribute\"\u003E--mount\u003C\u002Fspan\u003E=type=cache,target=\u002Fapp\u002Fnode_modules,id=my_app_npm_module,sharing=locked\\\n    \u003Cspan class=\"hljs-attribute\"\u003E--mount\u003C\u002Fspan\u003E=type=cache,target=\u002Froot\u002F.npm,id=npm_cache \\\n    npm install \nCOPY . .\n\u003Cspan class=\"hljs-builtin-name\"\u003ERUN\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-attribute\"\u003E--mount\u003C\u002Fspan\u003E=type=cache,target=\u002Fapp\u002Fnode_modules,id=my_app_npm_module,sharing=locked \\\n    # \u003Cspan class=\"hljs-attribute\"\u003E--mount\u003C\u002Fspan\u003E=type=cache,target=\u002Fapp\u002Fdist,id=my_app_dist,sharing=locked \\\n    npm \u003Cspan class=\"hljs-builtin-name\"\u003Erun\u003C\u002Fspan\u003E build\nEXPOSE 8080\nCMD [\u003Cspan class=\"hljs-string\"\u003E&quot;http-server&quot;\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-string\"\u003E&quot;dist&quot;\u003C\u002Fspan\u003E]\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch3 id=\"构建镜像\"\u003E构建镜像\u003C\u002Fh3\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"hljs-attribute\"\u003EDOCKER_BUILDKIT\u003C\u002Fspan\u003E=1 docker build -t vue:buildx .\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E对比查看，tag为buildx的镜像体积为：124MB。\u003C\u002Fp\u003E\n\u003Cp\u003E体积减少了一半，是用buildkit对node_modules进行缓存处理。\u003C\u002Fp\u003E\n"}}}("用docker构建vue项目镜像，与buildkit体积对比"))]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');(function(){try{eval("async function x(){}");var main="/client/client.1097f7bb.js"}catch(e){main="/client/legacy/client.acb7f38a.js"};var s=document.createElement("script");try{new Function("if(0)import('')")();s.src=main;s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@2.0.4.js";s.setAttribute("data-main",main);}document.head.appendChild(s);}());</script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-170295070-1"></script> <script> window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-170295070-1'); </script> 