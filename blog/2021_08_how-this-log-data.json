{"title":"vue是怎么在mounted、created等中访问到data数据的？","description":"vue源码分析，为什么可以在created、mounted中通过this[key]访问vue中的data","keywords":"vue，源码，this，data，created，mounted，生命周期","labels":["vue源码"],"date":"2021-08-16","path":"2021/08/how-this-log-data.md","slug":"2021_08_how-this-log-data","html":"<p><div style=\"text-align: center;\"><img align=\"center\" style=\"width: -webkit-fill-available;margin-bottom: 20px;border-radius: 8px;background: #f8fdf3;\" data-zoomable src=\"https://i.loli.net/2021/08/16/9wQxRlcUEeNstY8.png\" alt=\"defineProperty\" ></div>  </p>\n<pre><code class=\"language-javascript\">{\n  <span class=\"hljs-function\"><span class=\"hljs-title\">mounted</span>(<span class=\"hljs-params\"></span>)</span> {\n    <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-built_in\">this</span>.name) <span class=\"hljs-comment\">// GzhiYi</span>\n  },\n  <span class=\"hljs-function\"><span class=\"hljs-title\">data</span>(<span class=\"hljs-params\"></span>)</span> {\n    <span class=\"hljs-keyword\">return</span> {\n      <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">&#x27;GzhiYi&#x27;</span>\n    }\n  }\n}\n</code></pre>\n<p>如上代码，我们可以在<code>mounted</code>的周期钩子中访问到在data中定义到name属性。为什么可以访问到呢，可以通过vue源码中找到原因。</p>\n<p>这涉及到了vue在new实例后处理的事情。</p>\n<h3 id=\"涉及源码及相关文件\">涉及源码及相关文件</h3>\n<p><code>src/core/instance/index.js</code>，这个文件中找到vue构造函数。其中<code>initMixin(Vue)</code>对Vue实例进行初始化操作。该方法在<code>src/core/instance/init.js</code>中进行定义。由于是查看data相关的数据处理动向，我们可以定位到<code>State</code>的初始化方法<code>initState(vm)</code>。</p>\n<p>继续定位到state的初始化方法。</p>\n<pre><code class=\"language-javascript\">// 这里表示opts中如果opts.<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span>有值则初始化<span class=\"hljs-keyword\">data</span>值。</span>\n<span class=\"hljs-title\">if</span> (opts.<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span>) {\n  <span class=\"hljs-title\">initData</span>(<span class=\"hljs-title\">vm</span>)\n} else {\n  <span class=\"hljs-title\">observe</span>(<span class=\"hljs-title\">vm</span>.<span class=\"hljs-title\">_data</span> = {}, true /* asRootData */)</span>\n}\n</code></pre>\n<p>在initData中，可以看到：</p>\n<pre><code class=\"language-js\">// 这里连续赋值。如果<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span>是一个函数，则走getData</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span> = vm._data = typeof <span class=\"hljs-keyword\">data</span> === &#x27;function&#x27;</span>\n  ? getData(<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span>, vm)</span>\n  : <span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span> || {}</span>\n\n// 在getData中，是这样对<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span>进行处理的</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span>.call(<span class=\"hljs-title\">vm</span>, <span class=\"hljs-title\">vm</span>)</span>\n</code></pre>\n<p>最后这里调用函数原型的<a target='_blank'  href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/call\">call</a>方法，实际等同于<code>vm.data(vm)</code>。由于data是一个函数，那在本例中<code>getData</code>返回的就是：</p>\n<pre><code class=\"language-json\">{\n  <span class=\"hljs-built_in\">name</span>: <span class=\"hljs-string\">&quot;GzhiYi&quot;</span>\n}\n</code></pre>\n<p>额外增加一个预告，我们在vue中，一般定义data都是<code>function</code>的形式，这是建议的，但其实也可以定义为<code>object</code>的方式，从源码中可以看到<code>getData</code>这个函数存在着<code>pushTarget</code>等函数的处理，这是后续我要去看源码理解的。暂时不牵挂。</p>\n<h3 id=\"在实例中对data进行代理proxy\">在实例中对data进行代理(proxy)</h3>\n<p>符合本内容的主要数据操作其实在这里。</p>\n<pre><code class=\"language-js\">proxy(vm, <span class=\"hljs-string\">`_data`</span>, key)\n<span class=\"hljs-comment\">// 追到proxy函数中，核心的就是对象的defineProperty方法。</span>\n<span class=\"hljs-comment\">// defineProperty方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性，并返回这个对象。</span>\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">proxy</span> (<span class=\"hljs-params\">target: <span class=\"hljs-built_in\">Object</span>, sourceKey: <span class=\"hljs-built_in\">string</span>, key: <span class=\"hljs-built_in\">string</span></span>) </span>{\n  sharedPropertyDefinition.get = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">proxyGetter</span> (<span class=\"hljs-params\"></span>) </span>{\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">this</span>[sourceKey][key]\n  }\n  sharedPropertyDefinition.set = <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">proxySetter</span> (<span class=\"hljs-params\">val</span>) </span>{\n    <span class=\"hljs-built_in\">this</span>[sourceKey][key] = val\n  }\n  <span class=\"hljs-built_in\">Object</span>.defineProperty(target, key, sharedPropertyDefinition)\n}\n<span class=\"hljs-comment\">// 就是要把vm实例化时通过遍历data的值并把data的key-value定义到vm中。</span>\n</code></pre>\n<p>由于要把data的每一项定义到vm上，所以vue在初始化state的时候，需要检测vm对象中是否已经有了data中定义的key。如果定义重复，也就是大概使用vue的人都会遇到以下的提醒：</p>\n<pre><code class=\"language-js\">warn(\n  `<span class=\"hljs-function\"><span class=\"hljs-keyword\">Method</span> &quot;$<span class=\"hljs-comment\">{key}</span>&quot; <span class=\"hljs-title\">has</span> <span class=\"hljs-title\">already</span> <span class=\"hljs-title\">been</span> <span class=\"hljs-title\">defined</span> <span class=\"hljs-title\">as</span> <span class=\"hljs-title\">a</span> <span class=\"hljs-title\">data</span> <span class=\"hljs-title\">property</span>.`,\n  <span class=\"hljs-title\">vm</span>\n)</span>\n</code></pre>\n<p>所以，在vm中，也就是vue实例中，created和mounted都是vue实例的key，就可以通过<code>this[key]</code>去访问data中的值了。</p>\n<p>当然，要注意，<code>initState(vm)</code>是在<code>beforeCreate</code>这个钩子之后执行，所以beforeCreate是不能通过上面的方式进行访问的。</p>\n<p><div style=\"text-align: center;\"><img align=\"center\" style=\"width: -webkit-fill-available;margin-bottom: 20px;border-radius: 8px;background: #f8fdf3;\" data-zoomable src=\"https://i.loli.net/2021/08/16/twNof3mjWJT7A2r.png\" alt=\"hooks\" ></div>  </p>\n<p><strong>Vue版本：<a target='_blank'  href=\"https://github.com/vuejs/vue/archive/refs/tags/v2.6.14.zip\">2.6.14</a></strong></p>\n"}