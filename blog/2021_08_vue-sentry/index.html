<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1" name=viewport> <meta content=#333333 name=theme-color> <meta content=Mrn4dXO3Z_939geeswIgr2wIpspT6n7X5cX1Tjp69Ko name=google-site-verification> <base href=/ > <link href=global.css rel=stylesheet> <link href=manifest.json rel=manifest crossorigin=use-credentials> <link href=favicon.png rel=icon type=image/png> <link href=atom-one-light.min.css rel=stylesheet> <link href=client/client-87ec37cb.css rel=stylesheet><link href=client/[slug]-2cfb82a0.css rel=stylesheet> <title>vue引入sentry上报web异常-GzhiYi's blog</title><meta content=vue引入sentry作为页面异常监控；罗列了基本的引入方式，并就过程中遇到的问题进行记录。 name=description data-svelte=svelte-2vncnt><meta content="vue,sentry,sourcemap,UglifyJsPlugin,node,webpack,not working,upload" name=keywords data-svelte=svelte-2vncnt> <link href=/client/client.e0961b94.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/client-87ec37cb.css rel=preload as=style><link href=/client/[slug].13458e28.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/config.026ad977.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/inject_styles.5607aec6.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/[slug]-2cfb82a0.css rel=preload as=style></head> <body> <div id=sapper> <nav class=svelte-1vrbr95><ul class=svelte-1vrbr95><li class=svelte-1vrbr95><a href=blog aria-current=page class=svelte-1vrbr95 rel=prefetch>文章列表</a></ul></nav> <div style=width:100%;height:56px;background-color:#dee2e8></div> <main class=svelte-1ca6gui style=padding:1rem> <div class="svelte-vusc9 base"><div class="svelte-vusc9 title">vue引入sentry上报web异常</div> <span class="svelte-vusc9 author">GzhiYi · 2021-08-20</span> <div class=label>vue</div></div> <div class="svelte-vusc9 content"><p><div style=text-align:center><img align=center alt=sentry data-zoomable src=https://i.loli.net/2021/08/20/fLZgCaUNwyb5VI8.png style=width:-webkit-fill-available;margin-bottom:20px;border-radius:8px;background:#f8fdf3></div><p></p> <p>如果不知道sentry的，可以到官网了解一下功能。<a href=https://sentry.io/ target=_blank>sentry</a>是一个错误上报，用于监控线上代码运行情况的一个工具。在对vue-cli项目引入sentry时，出现了一些问题，所以需要记录一下，也方便如果有遇到这些问题的人。</p> <h3 id=引入>引入</h3> <p>引入方式不多说，简单提一下。</p> <p>在vue实例初始化之前完成sentry的引入。</p> <pre><code class=language-shell>yarn <span class=hljs-builtin-name>add</span> raven-js
</code></pre> <pre><code class=language-js><span class=hljs-keyword>import</span> Raven <span class=hljs-keyword>from</span> <span class=hljs-string>'raven-js'</span>
<span class=hljs-keyword>import</span> RavenVue <span class=hljs-keyword>from</span> <span class=hljs-string>'raven-js/plugins/vue'</span>

<span class=hljs-comment>// sentryDSN 需要填入</span>

<span class=hljs-keyword>if</span> (isProduction) Raven.config(sentryDSN, {
  release: <span class=hljs-string>'xxxx'</span>
}).addPlugin(RavenVue, Vue).install()
</code></pre> <h3 id=sourcemap>sourceMap</h3> <p>前端项目在部署到线上环境之后，都会进行代码压缩混淆。所以线上报错的异常会指向混淆的代码位置，会不容易定位问题。sourceMap不能部署到线上环境，不然会泄露代码。尽管前端代码没有秘密，但可以通过压缩混淆增加秘密的访问成本。</p> <p><strong>所以要把sourceMap上传到sentry但不能部署到线上目录</strong></p> <h4 id=开启构建生成sourcemap>开启构建生成sourceMap</h4> <p>在<code>vue.config.js</code>中，开启productionSourceMap</p> <pre><code class=language-js><span class=hljs-attr>productionSourceMap:</span> <span class=hljs-literal>true</span>
</code></pre> <h4 id=无法打包出sourcemap>无法打包出sourceMap</h4> <p>一般而言，开启该属性会在build构建生产文件内的js目录看到对应的.map文件。</p> <p>不过我遇到就算开启了sourceMap也没有正确打包生成.map文件的问题。 如果出现这样的问题，考虑是否有其余的插件影响到.map文件的生成。</p> <p>最后发现是webpack插件<a href=https://webpack.docschina.org/plugins/uglifyjs-webpack-plugin/ target=_blank>UglifyjsWebpackPlugin</a>导致无法打包出.map。</p> <pre><code class=language-js><span class=hljs-comment>// 就算开启了productionSourceMap也要把下面的选项开启</span>
<span class=hljs-keyword>new</span> UglifyJsPlugin({
  sourceMap: <span class=hljs-literal>true</span>,
})
</code></pre> <h3 id=使用sentrycliplugin上传soucemap>使用SentryCliPlugin上传souceMap</h3> <pre><code class=language-js><span class=hljs-keyword>if</span> (isProduction) {
  config.plugin(<span class=hljs-string>'sentry'</span>).use(SentryPlugin, [
    {
      <span class=hljs-regexp>//</span> 指定忽略文件配置
      ignoreFile: <span class=hljs-string>'.gitignore'</span>,
      <span class=hljs-regexp>//</span> 指定上传目录
      include: <span class=hljs-string>'./dist'</span>,
      <span class=hljs-regexp>//</span> 指定sentry上传配置
      configFile: <span class=hljs-string>'./.sentryclirc'</span>,
      <span class=hljs-regexp>//</span> 指定发布版本, 需要和raven配置的release一致
      release: <span class=hljs-string>'xxxx'</span>,
      <span class=hljs-regexp>//</span> 保持与publicPath相符
      urlPrefix: publicPath
    }
  ])
}
</code></pre> <h4 id=上传遇到429错误>上传遇到429错误</h4> <p><div style=text-align:center><img align=center alt=sentry-429 data-zoomable src=https://i.loli.net/2021/08/20/picIGw19U2k4Rvj.png style=width:-webkit-fill-available;margin-bottom:20px;border-radius:8px;background:#f8fdf3></div><p></p> <p>出错原因是请求并发过大，要解决这个问题，需要改为手动通过node调用sentryapi上传souceMap。</p> <p>通过node上传，可以限制上传的并发数，以达到目的。</p> </div> <div class="svelte-vusc9 contact"><div style=line-height:20px>如果你对这页内容有疑问，欢迎联系我！</div> <a href="mailto:zhiyi.gong@outlook.com?subject=【重要】vue引入sentry上报web异常&body=gzhiyi.top/blog/2021_08_vue-sentry" target=_blank>邮箱 </a> <br> <a href=https://github.com/gzhiyi target=_blank>github </a> </div> </main></div> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,{post:{title:"vue引入sentry上报web异常",description:"vue引入sentry作为页面异常监控；罗列了基本的引入方式，并就过程中遇到的问题进行记录。",keywords:"vue,sentry,sourcemap,UglifyJsPlugin,node,webpack,not working,upload",labels:["vue"],date:"2021-08-20",path:"2021\u002F08\u002Fvue-sentry.md",slug:"2021_08_vue-sentry",html:"\u003Cp\u003E\u003Cdiv style=\"text-align: center;\"\u003E\u003Cimg align=\"center\" style=\"width: -webkit-fill-available;margin-bottom: 20px;border-radius: 8px;background: #f8fdf3;\" data-zoomable src=\"https:\u002F\u002Fi.loli.net\u002F2021\u002F08\u002F20\u002FfLZgCaUNwyb5VI8.png\" alt=\"sentry\" \u003E\u003C\u002Fdiv\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E如果不知道sentry的，可以到官网了解一下功能。\u003Ca target='_blank'  href=\"https:\u002F\u002Fsentry.io\u002F\"\u003Esentry\u003C\u002Fa\u003E是一个错误上报，用于监控线上代码运行情况的一个工具。在对vue-cli项目引入sentry时，出现了一些问题，所以需要记录一下，也方便如果有遇到这些问题的人。\u003C\u002Fp\u003E\n\u003Ch3 id=\"引入\"\u003E引入\u003C\u002Fh3\u003E\n\u003Cp\u003E引入方式不多说，简单提一下。\u003C\u002Fp\u003E\n\u003Cp\u003E在vue实例初始化之前完成sentry的引入。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-shell\"\u003Eyarn \u003Cspan class=\"hljs-builtin-name\"\u003Eadd\u003C\u002Fspan\u003E raven-js\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-js\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E Raven \u003Cspan class=\"hljs-keyword\"\u003Efrom\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&#x27;raven-js&#x27;\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E RavenVue \u003Cspan class=\"hljs-keyword\"\u003Efrom\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&#x27;raven-js\u002Fplugins\u002Fvue&#x27;\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F sentryDSN 需要填入\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (isProduction) Raven.config(sentryDSN, {\n  release: \u003Cspan class=\"hljs-string\"\u003E&#x27;xxxx&#x27;\u003C\u002Fspan\u003E\n}).addPlugin(RavenVue, Vue).install()\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch3 id=\"sourcemap\"\u003EsourceMap\u003C\u002Fh3\u003E\n\u003Cp\u003E前端项目在部署到线上环境之后，都会进行代码压缩混淆。所以线上报错的异常会指向混淆的代码位置，会不容易定位问题。sourceMap不能部署到线上环境，不然会泄露代码。尽管前端代码没有秘密，但可以通过压缩混淆增加秘密的访问成本。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003E所以要把sourceMap上传到sentry但不能部署到线上目录\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\u003Ch4 id=\"开启构建生成sourcemap\"\u003E开启构建生成sourceMap\u003C\u002Fh4\u003E\n\u003Cp\u003E在\u003Ccode\u003Evue.config.js\u003C\u002Fcode\u003E中，开启productionSourceMap\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-js\"\u003E\u003Cspan class=\"hljs-attr\"\u003EproductionSourceMap:\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-literal\"\u003Etrue\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch4 id=\"无法打包出sourcemap\"\u003E无法打包出sourceMap\u003C\u002Fh4\u003E\n\u003Cp\u003E一般而言，开启该属性会在build构建生产文件内的js目录看到对应的.map文件。\u003C\u002Fp\u003E\n\u003Cp\u003E不过我遇到就算开启了sourceMap也没有正确打包生成.map文件的问题。\n如果出现这样的问题，考虑是否有其余的插件影响到.map文件的生成。\u003C\u002Fp\u003E\n\u003Cp\u003E最后发现是webpack插件\u003Ca target='_blank'  href=\"https:\u002F\u002Fwebpack.docschina.org\u002Fplugins\u002Fuglifyjs-webpack-plugin\u002F\"\u003EUglifyjsWebpackPlugin\u003C\u002Fa\u003E导致无法打包出.map。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-js\"\u003E\u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 就算开启了productionSourceMap也要把下面的选项开启\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003Enew\u003C\u002Fspan\u003E UglifyJsPlugin({\n  sourceMap: \u003Cspan class=\"hljs-literal\"\u003Etrue\u003C\u002Fspan\u003E,\n})\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch3 id=\"使用sentrycliplugin上传soucemap\"\u003E使用SentryCliPlugin上传souceMap\u003C\u002Fh3\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-js\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (isProduction) {\n  config.plugin(\u003Cspan class=\"hljs-string\"\u003E&#x27;sentry&#x27;\u003C\u002Fspan\u003E).use(SentryPlugin, [\n    {\n      \u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E 指定忽略文件配置\n      ignoreFile: \u003Cspan class=\"hljs-string\"\u003E&#x27;.gitignore&#x27;\u003C\u002Fspan\u003E,\n      \u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E 指定上传目录\n      include: \u003Cspan class=\"hljs-string\"\u003E&#x27;.\u002Fdist&#x27;\u003C\u002Fspan\u003E,\n      \u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E 指定sentry上传配置\n      configFile: \u003Cspan class=\"hljs-string\"\u003E&#x27;.\u002F.sentryclirc&#x27;\u003C\u002Fspan\u003E,\n      \u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E 指定发布版本, 需要和raven配置的release一致\n      release: \u003Cspan class=\"hljs-string\"\u003E&#x27;xxxx&#x27;\u003C\u002Fspan\u003E,\n      \u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E 保持与publicPath相符\n      urlPrefix: publicPath\n    }\n  ])\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch4 id=\"上传遇到429错误\"\u003E上传遇到429错误\u003C\u002Fh4\u003E\n\u003Cp\u003E\u003Cdiv style=\"text-align: center;\"\u003E\u003Cimg align=\"center\" style=\"width: -webkit-fill-available;margin-bottom: 20px;border-radius: 8px;background: #f8fdf3;\" data-zoomable src=\"https:\u002F\u002Fi.loli.net\u002F2021\u002F08\u002F20\u002FpicIGw19U2k4Rvj.png\" alt=\"sentry-429\" \u003E\u003C\u002Fdiv\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E出错原因是请求并发过大，要解决这个问题，需要改为手动通过node调用sentryapi上传souceMap。\u003C\u002Fp\u003E\n\u003Cp\u003E通过node上传，可以限制上传的并发数，以达到目的。\u003C\u002Fp\u003E\n"}}]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');(function(){try{eval("async function x(){}");var main="/client/client.e0961b94.js"}catch(e){main="/client/legacy/client.c8e72cd1.js"};var s=document.createElement("script");try{new Function("if(0)import('')")();s.src=main;s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@2.0.4.js";s.setAttribute("data-main",main);}document.head.appendChild(s);}());</script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-170295070-1"></script> <script> window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-170295070-1'); </script> 