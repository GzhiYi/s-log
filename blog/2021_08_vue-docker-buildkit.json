{"title":"用docker构建vue项目镜像，与buildkit体积对比","description":"用docker构建vue项目镜像，与buildkit体积对比","keywords":"docker，vue，buildkit，体积，缓存","labels":["docker"],"date":"2021-08-03","path":"2021/08/vue-docker-buildkit.md","slug":"2021_08_vue-docker-buildkit","html":"<h2 id=\"使用dockerfile去打包一个vue项目镜像\">使用Dockerfile去打包一个vue项目镜像</h2>\n<pre><code class=\"language-bash\">vue <span class=\"hljs-meta\">create</span> hello-world\ncd hello-world <span class=\"hljs-variable\">&amp;&amp;</span> touch Dockerfile\n</code></pre>\n<p>Dockerfile内容</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-keyword\">FROM</span> node:lts-alpine\n<span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> npm install -g http-server</span>\n<span class=\"hljs-keyword\">WORKDIR</span><span class=\"bash\"> /app</span>\n<span class=\"hljs-keyword\">COPY</span><span class=\"bash\"> package*.json ./</span>\n<span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> npm install </span>\n<span class=\"hljs-keyword\">COPY</span><span class=\"bash\"> . .</span>\n<span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> npm run build</span>\n<span class=\"hljs-keyword\">EXPOSE</span> <span class=\"hljs-number\">8080</span>\n<span class=\"hljs-keyword\">CMD</span><span class=\"bash\"> [<span class=\"hljs-string\">&quot;http-server&quot;</span>, <span class=\"hljs-string\">&quot;dist&quot;</span>]</span>\n</code></pre>\n<h3 id=\"镜像构建与容器运行\">镜像构建与容器运行</h3>\n<pre><code class=\"language-bash\">docker build -t vue:demo . <span class=\"hljs-comment\"># 构建镜像</span>\ndocker <span class=\"hljs-built_in\">run</span> -<span class=\"hljs-keyword\">it</span> -d -P vue:demo\ndocker container ls <span class=\"hljs-comment\"># 查看映射的端口</span>\n</code></pre>\n<p>查看生成的镜像大小为：287MB。</p>\n<h3 id=\"使用buildkit优化镜像体积\">使用buildkit优化镜像体积</h3>\n<p>新的Dockerfile</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># systax = docker/dockerfile:experimental</span>\n<span class=\"hljs-keyword\">FROM</span> node:lts-alpine\n<span class=\"hljs-builtin-name\">RUN</span> npm install -g http-server\nWORKDIR /app\nCOPY package*.json ./\n<span class=\"hljs-builtin-name\">RUN</span> <span class=\"hljs-attribute\">--mount</span>=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked\\\n    <span class=\"hljs-attribute\">--mount</span>=type=cache,target=/root/.npm,id=npm_cache \\\n    npm install \nCOPY . .\n<span class=\"hljs-builtin-name\">RUN</span> <span class=\"hljs-attribute\">--mount</span>=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \\\n    # <span class=\"hljs-attribute\">--mount</span>=type=cache,target=/app/dist,id=my_app_dist,sharing=locked \\\n    npm <span class=\"hljs-builtin-name\">run</span> build\nEXPOSE 8080\nCMD [<span class=\"hljs-string\">&quot;http-server&quot;</span>, <span class=\"hljs-string\">&quot;dist&quot;</span>]\n</code></pre>\n<h3 id=\"构建镜像\">构建镜像</h3>\n<pre><code class=\"language-bash\"><span class=\"hljs-attribute\">DOCKER_BUILDKIT</span>=1 docker build -t vue:buildx .\n</code></pre>\n<p>对比查看，tag为buildx的镜像体积为：124MB。</p>\n<p>体积减少了一半，是用buildkit对node_modules进行缓存处理。</p>\n"}