{"title":"lodash数组中difference方法","description":"lodash中difference、differenceBy、differenceWith方法的使用以及分析","keywords":"lodash，difference，differenceBy，differenceWith，数组，源码分析,每天一个lodash函数","labels":["lodash"],"date":"2021-08-06","path":"2021/08/lodash-array-difference.md","slug":"2021_08_lodash-array-difference","html":"<h2 id=\"difference\">Difference</h2>\n<p>创建一个具有唯一array值的数组，每个值不包含在其他给定的数组中。（注：即创建一个新数组，这个数组中的值，为第一个数字（array 参数）排除了给定数组中的值。）该方法使用SameValueZero做相等比较。结果值的顺序是由第一个数组中的顺序确定。</p>\n<pre><code class=\"language-javascript\"><span class=\"hljs-attribute\">_</span>.difference([<span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>],<span class=\"hljs-meta\"> [4, 2])\n// [3, 1]</span>\n</code></pre>\n<h3 id=\"理解\">理解</h3>\n<p>对这个用法，可以理解为抽出属于第一个参数而不属于第二个参数的值（找出右边数组中没有在左边数组内的）。</p>\n<p>其中有一个SamealueZero的匹配规则，大致的规则如下：\n例如比较x、y</p>\n<ol>\n<li>如果x与y不同，返回false</li>\n<li>如果x为数值，则</li>\n</ol>\n<ul>\n<li>如果x是NaN，y也是NaN，返回true</li>\n<li>如果x是-0，y是+0，返回true</li>\n</ul>\n<h3 id=\"源码\">源码</h3>\n<pre><code class=\"language-javascript\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">difference</span><span class=\"hljs-params\">(array, <span class=\"hljs-rest_arg\">...values</span>)</span> </span>{\n  <span class=\"hljs-keyword\">return</span> isArrayLikeObject(array)\n  <span class=\"hljs-comment\">// baseFlatten用于拍平数组</span>\n    ? baseDifference(array, baseFlatten(values, <span class=\"hljs-number\">1</span>, isArrayLikeObject, <span class=\"hljs-literal\">true</span>))\n    : []\n}\n</code></pre>\n<p>这函数调用的起飞阿，我分析lodash函数的代码，还得刨到底。</p>\n<h4 id=\"isarraylikeobject\">isArrayLikeObject</h4>\n<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">// 这个函数和isArrayLike差不多，但它会另外的检查传入的value是否为object</span>\n<span class=\"hljs-comment\">// 总之可以模糊的说用于判断是否是可迭代的类型</span>\n<span class=\"hljs-keyword\">function</span> is<span class=\"hljs-constructor\">ArrayLikeObject(<span class=\"hljs-params\">value</span>)</span> {\n  return is<span class=\"hljs-constructor\">ObjectLike(<span class=\"hljs-params\">value</span>)</span><span class=\"hljs-operator\"> &amp;&amp; </span>is<span class=\"hljs-constructor\">ArrayLike(<span class=\"hljs-params\">value</span>)</span>\n}\n\n\n<span class=\"hljs-comment\">// 1 </span>\n<span class=\"hljs-comment\">// 用以判断传入的值是否为对象类型，因为typeof null === &#x27;object&#x27;，所以要增加一个判断</span>\n<span class=\"hljs-keyword\">function</span> is<span class=\"hljs-constructor\">ObjectLike(<span class=\"hljs-params\">value</span>)</span> {\n  return typeof value<span class=\"hljs-operator\"> === </span>&#x27;<span class=\"hljs-keyword\">object</span>&#x27;<span class=\"hljs-operator\"> &amp;&amp; </span>value !== null\n}\n\n<span class=\"hljs-comment\">// 2</span>\n<span class=\"hljs-comment\">// 由isLength判断value长度的方式来判断传入的value是否为ArrayLike</span>\n<span class=\"hljs-keyword\">function</span> is<span class=\"hljs-constructor\">ArrayLike(<span class=\"hljs-params\">value</span>)</span> {\n  return value != null<span class=\"hljs-operator\"> &amp;&amp; </span>typeof value !== &#x27;<span class=\"hljs-keyword\">function</span>&#x27;<span class=\"hljs-operator\"> &amp;&amp; </span>is<span class=\"hljs-constructor\">Length(<span class=\"hljs-params\">value</span>.<span class=\"hljs-params\">length</span>)</span>\n}\n\n<span class=\"hljs-comment\">// 3</span>\n<span class=\"hljs-comment\">// 判断传入的长度值是否有效！</span>\n<span class=\"hljs-comment\">// 有效的条件：大于-1 并且 任意整数 并且是安全整数（能够准确区分两个不相同的值）</span>\n\n<span class=\"hljs-keyword\">function</span> is<span class=\"hljs-constructor\">Length(<span class=\"hljs-params\">value</span>)</span> {\n  return typeof value<span class=\"hljs-operator\"> === </span>&#x27;number&#x27;<span class=\"hljs-operator\"> &amp;&amp;\n    </span>value &gt; -<span class=\"hljs-number\">1</span><span class=\"hljs-operator\"> &amp;&amp; </span>value % <span class=\"hljs-number\">1</span><span class=\"hljs-operator\"> == </span><span class=\"hljs-number\">0</span><span class=\"hljs-operator\"> &amp;&amp; </span>value &lt;= MAX_SAFE_INTEGER\n}\n</code></pre>\n<h4 id=\"basedifference\">baseDifference</h4>\n<pre><code class=\"language-javascript\">// iteratee在此（difference函数）调用默认为<span class=\"hljs-literal\">false</span>\nfunction baseDifference(<span class=\"hljs-built_in\">array</span>, <span class=\"hljs-built_in\">values</span>, iteratee, comparator) {\n  // arrayIncludes(<span class=\"hljs-built_in\">array</span>, value)\n  // 判断value是否在<span class=\"hljs-built_in\">array</span>中\n  <span class=\"hljs-built_in\">let</span> includes = arrayIncludes\n  <span class=\"hljs-built_in\">let</span> isCommon = <span class=\"hljs-literal\">true</span>\n  const result = []\n  const valuesLength = <span class=\"hljs-built_in\">values</span>.<span class=\"hljs-built_in\">length</span>\n\n  <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-built_in\">array</span>.<span class=\"hljs-built_in\">length</span>) {\n    <span class=\"hljs-built_in\">return</span> result\n  }\n  // 这几处暂时不需要理解\n  <span class=\"hljs-keyword\">if</span> (iteratee) {\n    <span class=\"hljs-built_in\">values</span> = <span class=\"hljs-built_in\">map</span>(<span class=\"hljs-built_in\">values</span>, (value) =&gt; iteratee(value))\n  }\n  <span class=\"hljs-keyword\">if</span> (comparator) {\n    includes = arrayIncludesWith\n    isCommon = <span class=\"hljs-literal\">false</span>\n  }\n  // lodash中该值定义为LARGE_ARRAY_SIZE = <span class=\"hljs-number\">200</span>\n  <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">values</span>.<span class=\"hljs-built_in\">length</span> &gt;= LARGE_ARRAY_SIZE) {\n    // cacheHas这个函数用于判断某个<span class=\"hljs-built_in\">key</span>是否在cache中\n    includes = cacheHas\n    isCommon = <span class=\"hljs-literal\">false</span>\n    <span class=\"hljs-built_in\">values</span> = <span class=\"hljs-built_in\">new</span> SetCache(<span class=\"hljs-built_in\">values</span>)\n  }\n\n  // labeled statement\n  // 严格模式下不能使用 https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/<span class=\"hljs-built_in\">label</span>\n  // 用于跳过某些遍历\n\n  outer:\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">let</span> value of <span class=\"hljs-built_in\">array</span>) {\n    const computed = iteratee == null ? value : iteratee(value)\n\n    value = (comparator || value !== <span class=\"hljs-number\">0</span>) ? value : <span class=\"hljs-number\">0</span>\n    <span class=\"hljs-keyword\">if</span> (isCommon &amp;&amp; computed === computed) {\n      <span class=\"hljs-built_in\">let</span> valuesIndex = valuesLength\n      <span class=\"hljs-keyword\">while</span> (valuesIndex--) {\n        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">values</span>[valuesIndex] === computed) {\n          continue outer\n        }\n      }\n      result.<span class=\"hljs-built_in\">push</span>(value)\n    }\n    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (!includes(<span class=\"hljs-built_in\">values</span>, computed, comparator)) {\n      result.<span class=\"hljs-built_in\">push</span>(value)\n    }\n  }\n  <span class=\"hljs-built_in\">return</span> result\n}\n</code></pre>\n"}