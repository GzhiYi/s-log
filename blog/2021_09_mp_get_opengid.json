{"title":"微信小程序获取群id的方式","description":"小程序怎么获取群的唯一标识，获取群id，opengid，怎么解密。这里有两种方式解密，一种是服务端，一种是云函数端。","keywords":"小程序，群id，opengid，解密，getGroupEnterInfo，CloudID解密，云函数获取群opengid，云函数解密群opengid","labels":["小程序"],"date":"2021-09-07","path":"2021/09/mp_get_opengid.md","slug":"2021_09_mp_get_opengid","html":"<p><div style=\"text-align: center;\"><img align=\"center\" style=\"width: -webkit-fill-available;margin-bottom: 20px;border-radius: 8px;background: #f8fdf3;\" data-zoomable src=\"https://i.loli.net/2021/09/07/MWD9UtfXIVFZzPj.png\" alt=\"图 1\" ></div></p>\n<p>如果小程序中有应用场景涉及到需要获取群的唯一标识的，可以获取opengid用以区分。</p>\n<p><code>wx.getGroupEnterInfo()</code>可以获取到opengid。</p>\n<h3 id=\"回调内容\">回调内容</h3>\n<pre><code>wx.getGroupEnterInfo({\n  success(res) {\n    <span class=\"hljs-regexp\">//</span> errMsg 错误信息    \n    <span class=\"hljs-regexp\">//</span> encryptedData 加密数据\n    <span class=\"hljs-regexp\">//</span> iv 加密算法的初始向量\n    <span class=\"hljs-regexp\">//</span> cloudID 敏感数据对应的云 ID，开通云开发的小程序才会返回，可通过云调用直接获取开放数据\n  }\n})\n</code></pre>\n<p>如果解密成功，将会获取opengid。</p>\n<h3 id=\"服务端解密encrypteddata获取opengid\">服务端解密encryptedData获取opengid</h3>\n<p>此处以<code>nodejs</code>为例子，需要准备的内容参数：</p>\n<ol>\n<li>appId。小程序的appId。</li>\n<li>session_key。小程序会话key，获取方式：\n<div style=\"text-align: center;\"><img align=\"center\" style=\"width: -webkit-fill-available;margin-bottom: 20px;border-radius: 8px;background: #f8fdf3;\" data-zoomable src=\"https://i.loli.net/2021/09/07/cmuFGA7rZHLJzh1.png\" alt=\"session_key获取\" ></div> </li>\n<li>encryptedData。上面提到的加密数据。</li>\n<li>iv。加密算法的初始向量。</li>\n</ol>\n<pre><code class=\"language-js\"><span class=\"hljs-regexp\">//</span> 引入 WXBizDataCrypt\n<span class=\"hljs-regexp\">//</span>  WXBizDataCrypt下载地址：https:<span class=\"hljs-regexp\">//</span>res.wx.qq.com<span class=\"hljs-regexp\">/wxdoc/</span>dist<span class=\"hljs-regexp\">/assets/m</span>edia/aes-sample.eae1f364.zip，在里面找到。\nconst WXBizDataCrypt = require(<span class=\"hljs-string\">&#x27;./WXBizDataCrypt&#x27;</span>)\n\nconst appId = <span class=\"hljs-string\">&#x27;&#x27;</span>\nconst sessionKey = <span class=\"hljs-string\">&#x27;&#x27;</span>\nconst encryptedData = <span class=\"hljs-string\">&#x27;&#x27;</span>\nconst iv = <span class=\"hljs-string\">&#x27;&#x27;</span>\n\nconst pc = new WXBizDataCrypt(appId, sessionKey)\n\n<span class=\"hljs-regexp\">//</span> 解密后的数据\nconst data = pc.decryptData(encryptedData , iv)\n</code></pre>\n<h3 id=\"云函数解密opengid\">云函数解密opengid</h3>\n<p>需要准备一个接受调用解密的云函数。</p>\n<p>在小程序端调用：</p>\n<pre><code class=\"language-js\">const cloudID = <span class=\"hljs-string\">&#x27;&#x27;</span> <span class=\"hljs-comment\">// 这里是调用getGroupEnterInfo返回的cloudID</span>\nwx<span class=\"hljs-selector-class\">.cloud</span><span class=\"hljs-selector-class\">.callFunction</span>({\n  name: <span class=\"hljs-string\">&#x27;decrypt&#x27;</span>,\n  data: {\n    groupData: wx<span class=\"hljs-selector-class\">.cloud</span><span class=\"hljs-selector-class\">.CloudID</span>(cloudID), <span class=\"hljs-comment\">// 这个 CloudID 值到云函数端会被替换</span>\n    <span class=\"hljs-comment\">// 下面这个obj是错误示例，不会在云函数中把解密的opengid塞进obj，所以遵循上面的写法，只放在第一层</span>\n    obj: {\n      groupData: wx<span class=\"hljs-selector-class\">.cloud</span><span class=\"hljs-selector-class\">.CloudID</span>(cloudID), <span class=\"hljs-comment\">// 不要这么写！！</span>\n    }\n  }\n})\n</code></pre>\n<p>在云函数端，应该是这样的：</p>\n<pre><code class=\"language-js\">exports.main = <span class=\"hljs-keyword\">async</span> (<span class=\"hljs-keyword\">event</span>) =&gt; {\n  <span class=\"hljs-comment\">// groupData是和小程序端的命名是一致的，这样才能正确返回</span>\n  <span class=\"hljs-keyword\">return</span> {\n    code: <span class=\"hljs-number\">1</span>,\n    data: <span class=\"hljs-keyword\">event</span>.groupInfo.data,\n    msg: <span class=\"hljs-string\">&#x27;获取成功&#x27;</span>,\n  }\n}\n</code></pre>\n<h3 id=\"只显示群昵称\">只显示群昵称</h3>\n<p>小程序可以通过开发数据组件open-data展示群昵称，需要的参数为opengid。</p>\n<pre><code class=\"language-html\"><span class=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">open-data</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;groupName&quot;</span> <span class=\"hljs-attr\">open-gid</span>=<span class=\"hljs-string\">&quot;</span></span></span><span class=\"hljs-template-variable\">{{<span class=\"hljs-name\">opengid</span>}}</span><span class=\"xml\"><span class=\"hljs-tag\"><span class=\"hljs-string\">&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">open-data</span>&gt;</span></span>\n</code></pre>\n<p>如果想修改样式，需要在外面包一层view进行样式控制。</p>\n<p>不能通过一个固定的opengid获取群名，这在模拟器中调试是不成功的。</p>\n"}