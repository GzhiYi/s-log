{"title":"vue引入sentry上报web异常","description":"vue引入sentry作为页面异常监控；罗列了基本的引入方式，并就过程中遇到的问题进行记录。","keywords":"vue,sentry,sourcemap,UglifyJsPlugin,node,webpack,not working,upload","labels":["vue"],"date":"2021-08-20","path":"2021/08/vue-sentry.md","slug":"2021_08_vue-sentry","html":"<p><div style=\"text-align: center;\"><img align=\"center\" style=\"width: -webkit-fill-available;margin-bottom: 20px;border-radius: 8px;background: #f8fdf3;\" data-zoomable src=\"https://i.loli.net/2021/08/20/fLZgCaUNwyb5VI8.png\" alt=\"sentry\" ></div></p>\n<p>如果不知道sentry的，可以到官网了解一下功能。<a target='_blank'  href=\"https://sentry.io/\">sentry</a>是一个错误上报，用于监控线上代码运行情况的一个工具。在对vue-cli项目引入sentry时，出现了一些问题，所以需要记录一下，也方便如果有遇到这些问题的人。</p>\n<h3 id=\"引入\">引入</h3>\n<p>引入方式不多说，简单提一下。</p>\n<p>在vue实例初始化之前完成sentry的引入。</p>\n<pre><code class=\"language-shell\">yarn <span class=\"hljs-builtin-name\">add</span> raven-js\n</code></pre>\n<pre><code class=\"language-js\"><span class=\"hljs-keyword\">import</span> Raven <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;raven-js&#x27;</span>\n<span class=\"hljs-keyword\">import</span> RavenVue <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;raven-js/plugins/vue&#x27;</span>\n\n<span class=\"hljs-comment\">// sentryDSN 需要填入</span>\n\n<span class=\"hljs-keyword\">if</span> (isProduction) Raven.config(sentryDSN, {\n  release: <span class=\"hljs-string\">&#x27;xxxx&#x27;</span>\n}).addPlugin(RavenVue, Vue).install()\n</code></pre>\n<h3 id=\"sourcemap\">sourceMap</h3>\n<p>前端项目在部署到线上环境之后，都会进行代码压缩混淆。所以线上报错的异常会指向混淆的代码位置，会不容易定位问题。sourceMap不能部署到线上环境，不然会泄露代码。尽管前端代码没有秘密，但可以通过压缩混淆增加秘密的访问成本。</p>\n<p><strong>所以要把sourceMap上传到sentry但不能部署到线上目录</strong></p>\n<h4 id=\"开启构建生成sourcemap\">开启构建生成sourceMap</h4>\n<p>在<code>vue.config.js</code>中，开启productionSourceMap</p>\n<pre><code class=\"language-js\"><span class=\"hljs-attr\">productionSourceMap:</span> <span class=\"hljs-literal\">true</span>\n</code></pre>\n<h4 id=\"无法打包出sourcemap\">无法打包出sourceMap</h4>\n<p>一般而言，开启该属性会在build构建生产文件内的js目录看到对应的.map文件。</p>\n<p>不过我遇到就算开启了sourceMap也没有正确打包生成.map文件的问题。\n如果出现这样的问题，考虑是否有其余的插件影响到.map文件的生成。</p>\n<p>最后发现是webpack插件<a target='_blank'  href=\"https://webpack.docschina.org/plugins/uglifyjs-webpack-plugin/\">UglifyjsWebpackPlugin</a>导致无法打包出.map。</p>\n<pre><code class=\"language-js\"><span class=\"hljs-comment\">// 就算开启了productionSourceMap也要把下面的选项开启</span>\n<span class=\"hljs-keyword\">new</span> UglifyJsPlugin({\n  sourceMap: <span class=\"hljs-literal\">true</span>,\n})\n</code></pre>\n<h3 id=\"使用sentrycliplugin上传soucemap\">使用SentryCliPlugin上传souceMap</h3>\n<pre><code class=\"language-js\"><span class=\"hljs-keyword\">if</span> (isProduction) {\n  config.plugin(<span class=\"hljs-string\">&#x27;sentry&#x27;</span>).use(SentryPlugin, [\n    {\n      <span class=\"hljs-regexp\">//</span> 指定忽略文件配置\n      ignoreFile: <span class=\"hljs-string\">&#x27;.gitignore&#x27;</span>,\n      <span class=\"hljs-regexp\">//</span> 指定上传目录\n      include: <span class=\"hljs-string\">&#x27;./dist&#x27;</span>,\n      <span class=\"hljs-regexp\">//</span> 指定sentry上传配置\n      configFile: <span class=\"hljs-string\">&#x27;./.sentryclirc&#x27;</span>,\n      <span class=\"hljs-regexp\">//</span> 指定发布版本, 需要和raven配置的release一致\n      release: <span class=\"hljs-string\">&#x27;xxxx&#x27;</span>,\n      <span class=\"hljs-regexp\">//</span> 保持与publicPath相符\n      urlPrefix: publicPath\n    }\n  ])\n}\n</code></pre>\n<h4 id=\"上传遇到429错误\">上传遇到429错误</h4>\n<p><div style=\"text-align: center;\"><img align=\"center\" style=\"width: -webkit-fill-available;margin-bottom: 20px;border-radius: 8px;background: #f8fdf3;\" data-zoomable src=\"https://i.loli.net/2021/08/20/picIGw19U2k4Rvj.png\" alt=\"sentry-429\" ></div></p>\n<p>出错原因是请求并发过大，要解决这个问题，需要改为手动通过node调用sentryapi上传souceMap。</p>\n<p>通过node上传，可以限制上传的并发数，以达到目的。</p>\n"}